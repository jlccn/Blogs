<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="Scripts/jquery.min.js" type="text/javascript"></script>
    <script src="Res/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="Res/easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <link href="Res/easyui/themes/icon.css" rel="stylesheet" type="text/css" />
    <link href="Res/easyui/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="Res/StyleSheet.css" rel="stylesheet" type="text/css" />
    <script src="Scripts/json2.js" type="text/javascript"></script>
    <script src="Scripts/kindeditor-4.1.7/kindeditor-min.js" type="text/javascript"></script>
    <link href="Scripts/kindeditor-4.1.7/themes/default/default.css" rel="stylesheet" type="text/css" />
    <script src="Scripts/kindeditor-4.1.7/lang/zh_CN.js" type="text/javascript"></script>
    <script src="Ashx/Handler2.ashx" charset="utf-8" type="text/javascript"></script>   
    <script type="text/javascript">
        $(function () {
            $('#list_data').datagrid({
                title: '信息列表',
                width: 700,
                height: 500,
                nowrap: false,
                fitColumns: true,
                striped: true,
                border: true,
                fit: true, //自动大小 
                singleSelect: true,
                queryParams: { page: 1, rows: 20, key: '' },
                url: 'Ashx/Handler2.ashx/GetPageData',               
                pagination: true, //分页控件 
                toolbar: [
                {
                    id: 'btnDetail',
                    text: '详细',
                    iconCls: 'icon-details',
                    handler: viewRow
                },
                {
                    id: 'btnAdd',
                    text: '创建',
                    iconCls: 'icon-add',
                    handler: newRow
                },
                 {
                     id: 'btnEdit',
                     text: '编辑',
                     iconCls: 'icon-edit',
                     handler: editRow
                 },
                 {
                     id: 'btnRemove',
                     text: '删除',
                     iconCls: 'icon-remove',
                     handler: delRow
                 }
                  ]
            });            
            //设置分页控件 
            var p = $('#list_data').datagrid('getPager');
            $(p).pagination({
                pageSize: 15, //每页显示的记录条数，默认为10 
                pageList: [15, 20, 30], //可以设置每页记录条数的列表 
                beforePageText: '第', //页数文本框前显示的汉字 
                afterPageText: '页    共 {pages} 页',
                displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
            });
            function viewRow() {
                var row = $('#list_data').datagrid('getSelected');
                if (row) {
                    //icon四种设置："error"、"info"、"question"、"warning"d
                    $.messager.alert('操作提示', row.Id + ' ' + row.Subject, 'info');
                }
            }

            function delRow() {
                var row = $('#list_data').datagrid('getSelected');
                if (!row) {
                    $.messager.alert('操作提示', '请选择要删除的行', 'info');
                    return;
                }
                $.messager.confirm('确认', '是否真的删除?', function (r) {
                    if (r) {
                        $.net.Handler2.DeleteByID(row.Id, function (res) {
                            if (res == "OK") {
                                var index = $('#list_data').datagrid('getRowIndex', row);
                                $('#list_data').datagrid('deleteRow', index);
                                $.messager.alert('操作提示', '删除成功!', 'info');
                            } else {
                                $.messager.alert('操作提示', '删除失败!', 'error');
                            }
                        });
                    }
                });
            };
            $("<td style='padding: 0 8px;'><input id='ss' /></td>").prependTo(".datagrid-toolbar table tbody tr");
            $('#ss').searchbox({
                searcher: function (value) {
                    $('#list_data').datagrid("reload", { key: value });
                },
                prompt: '请输入关键字'
            });
        });
    </script>
</head>
<body>
    <table id="list_data">  <!--class="easyui-datagrid"不能加这个否则会两次加载-->
        <thead>
            <tr>
                <th data-options="field:'Id',width:50">
                    序号
                </th>
                <th data-options="field:'Subject',width:100">
                    主题
                </th>
                <th data-options="field:'Content',width:700">
                    内容
                </th>
                <th data-options="field:'PublishDate',width:100">
                    日期
                </th>
            </tr>
        </thead>
    </table>
    <!--新建、编辑对话框-->
    <div id="dlg" class="easyui-dialog" style="width: 700px; height: 380px; padding: 5px" closed="true" buttons="#dlg-buttons">
        <form id="fm">
        <div class="fitem">
            <label>主题:</label>
            <input name="Subject" style="width:300px" class="easyui-validatebox" required="true"/>
        </div>
        <div class="fitem">
            <label>内容:</label>
            <textarea name="Content" style="width:500px;height:260px;visibility:hidden;"></textarea>
        </div>        
        </form>
    </div>
    <div id="dlg-buttons">
        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="saveUser()">保存</a> 
        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel"
                onclick="javascript:$('#dlg').dialog('close')">取消</a>
    </div>
    <script type="text/javascript">
        var editor;
        KindEditor.ready(function (K) {
            editor = K.create('textarea[name="Content"]', {
                resizeType: 1,
                allowPreviewEmoticons: false,
                allowImageUpload: false,
                items: [
						'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline',
						'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
						'insertunorderedlist', '|', 'emoticons', 'image', 'link'],
                afterBlur: function () { this.sync(); }
            });
        }); 
        var url;
        function newRow() {
            $('#dlg').dialog('open').dialog('setTitle', '添加新信息');
            $('#fm').form('clear');
            editor.html('');
            url = 'Ashx/Handler2.ashx/Add';
        }
        function editRow() {
            var row = $('#list_data').datagrid('getSelected');
            if (row) {
                $('#dlg').dialog('open').dialog('setTitle', '编辑信息');
                $('#fm').form('load', row);
                editor.html(row.Content);
                url = 'Ashx/Handler2.ashx/UpdateByID?id=' + row.Id;
            }
        }
        function saveUser() {
            if (editor.html() == '') {
                $.messager.alert('操作提示', '请输入内容!', 'error');
                return;
            }     
            var r = $('#fm').form('validate');
            if (!r) { return; }
            $.ajax({
                type: "post",
                url: url,
                data: $("#fm").serialize(),
                success: function (res) {
                    if (res == "OK") {                                      
                        $('#dlg').dialog('close');
                        $('#list_data').datagrid('reload');
                        $.messager.alert('操作提示', '操作成功!', 'info');
                    }
                    else { $.messager.alert('操作提示', '操作失败!', 'error'); }
                }
            });
        }
        
    </script>   
</body>
</html>
